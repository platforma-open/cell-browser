ll := import("@platforma-sdk/workflow-tengo:ll")
wf := import("@platforma-sdk/workflow-tengo:workflow")
file := import("@platforma-sdk/workflow-tengo:file")
smart := import("@platforma-sdk/workflow-tengo:smart")
pSpec := import("@platforma-sdk/workflow-tengo:pframes.spec")
assets := import("@platforma-sdk/workflow-tengo:assets")
render := import("@platforma-sdk/workflow-tengo:render")
pFrames := import("@platforma-sdk/workflow-tengo:pframes")

util := import(":util")
annotations := import(":annotations")
annotationsStats := import(":annotations-stats")

wf.prepare(func(args) {
	return {
		countsRefColumn: is_undefined(args.countsRef) ? undefined : wf.resolve(args.countsRef)
	}
})
wf.body(func(args) {
	outputs := {}
	exports := {}

	annotationSpec := args.annotationSpec
	annotationAxesSpec := util.getAnnotationAxesSpec(args)

	if !is_undefined(annotationAxesSpec) && len(annotationSpec.steps) > 0 {
		computedAnnotations := annotations.computeCellAnnotations({
			title: annotationSpec.title,
			steps: annotationSpec.steps,
			countsRef: args.countsRef,
			annotationAxesSpec: annotationAxesSpec,
			shouldComputeFilters: true
		})

		outputs["filtersPf"] = pFrames.exportFrame(computedAnnotations["filtersPf"])
		outputs["annotationsPf"] = pFrames.exportFrame(computedAnnotations["annotationsPf"])

		computedStats := annotationsStats.computeAnnotationsStats({
			annotations: computedAnnotations.annotationsColumn
		})

		outputs["annotationStatsPf"] = pFrames.exportFrame(computedStats.annotationStatsPf)
		outputs["annotationStatsBySamplePf"] = pFrames.exportFrame(computedStats.annotationStatsBySamplePf)
	}

	return {
		outputs: outputs,
		exports: exports
	}
})
